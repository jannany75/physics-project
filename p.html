<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Newton’s Rings Analyzer</title>

<!-- OpenCV -->
<script async src="https://docs.opencv.org/4.8.0/opencv.js"></script>

<style>
:root {
  --primary: #2563eb;
  --bg: #f1f5f9;
  --card: #ffffff;
}

body {
  margin: 0;
  font-family: system-ui, Arial, sans-serif;
  background: var(--bg);
}

header {
  background: var(--primary);
  color: white;
  padding: 15px;
  text-align: center;
  font-size: 20px;
  font-weight: bold;
}

.container {
  max-width: 900px;
  margin: auto;
  padding: 15px;
}

.card {
  background: var(--card);
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.step {
  font-weight: bold;
  margin-bottom: 8px;
}

canvas {
  width: 100%;
  height: auto;
  border-radius: 8px;
  border: 1px solid #000;
  touch-action: manipulation;
}

.controls {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 10px;
}

input, button {
  padding: 12px;
  font-size: 16px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

button {
  background: var(--primary);
  color: white;
  border: none;
}

button:active {
  transform: scale(0.98);
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: center;
  font-size: 14px;
}

.result {
  margin-top: 10px;
  font-size: 18px;
  font-weight: bold;
  color: #16a34a;
  text-align: center;
}
.note {
  font-size: 14px;
  color: #555;
}
</style>
</head>

<body>

<header>Newton’s Rings Analyzer (OpenCV)</header>

<div class="container">

  <!-- STEP 1 -->
  <div class="card">
    <div class="step">Step 1: Upload Newton’s Rings Image</div>
    <input type="file" id="imageInput" accept="image/*">
  </div>

  <!-- STEP 2 -->
  <div class="card">
    <div class="step">Step 2: Tap the Center of Rings</div>
    <canvas id="canvas"></canvas>
    <p class="note">Tap once at the center for accurate detection</p>
  </div>

  <!-- STEP 3 -->
  <div class="card">
    <div class="step">Step 3: Enter Parameters</div>
    <div class="controls">
      <input type="number" id="Rvalue" placeholder="Radius of curvature R (mm)">
      <input type="number" id="ringsToUse" placeholder="Number of rings">
      <button onclick="detectRings()">Analyze</button>
    </div>
  </div>

  <!-- RESULTS -->
  <div class="card">
    <div class="step">Results</div>
    <table id="table">
      <tr>
        <th>n</th>
        <th>r (px)</th>
        <th>r²</th>
      </tr>
    </table>
    <div class="result" id="result"></div>
  </div>

</div>

<script>
let img = new Image();
let canvas = document.getElementById("canvas");
let ctx = canvas.getContext("2d");
let center = null;

document.getElementById("imageInput").addEventListener("change", e => {
  img.src = URL.createObjectURL(e.target.files[0]);
});

img.onload = () => {
  let scale = Math.min(window.innerWidth / img.width, 1);
  canvas.width = img.width * scale;
  canvas.height = img.height * scale;
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
};

canvas.addEventListener("click", e => {
  const rect = canvas.getBoundingClientRect();
  center = {
    x: e.clientX - rect.left,
    y: e.clientY - rect.top
  };
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  ctx.beginPath();
  ctx.arc(center.x, center.y, 6, 0, 2*Math.PI);
  ctx.fillStyle = "red";
  ctx.fill();
});

function detectRings() {
  if (!center) return alert("Tap the center first");
  if (typeof cv === "undefined") return alert("OpenCV still loading");

  let src = cv.imread(canvas);
  let gray = new cv.Mat();
  let circles = new cv.Mat();

  cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
  cv.GaussianBlur(gray, gray, new cv.Size(9,9), 2);

  cv.HoughCircles(gray, circles, cv.HOUGH_GRADIENT, 1, 25, 120, 30, 10, 0);

  let R = parseFloat(document.getElementById("Rvalue").value);
  let limit = parseInt(document.getElementById("ringsToUse").value);
  if (!R || !limit) return alert("Enter R and number of rings");

  let radii = [];
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

  for (let i = 0; i < circles.cols; i++) {
    let x = circles.data32F[i*3];
    let y = circles.data32F[i*3+1];
    let r = circles.data32F[i*3+2];
    let d = Math.hypot(x - center.x, y - center.y);
    if (d < 12) {
      radii.push(r);
      ctx.beginPath();
      ctx.arc(x, y, r, 0, 2*Math.PI);
      ctx.strokeStyle = "#2563eb";
      ctx.stroke();
    }
  }

  radii.sort((a,b)=>a-b);
  radii = radii.slice(0, limit);

  let table = document.getElementById("table");
  table.innerHTML = `<tr><th>n</th><th>r (px)</th><th>r²</th></tr>`;

  let sumNr2 = 0, sumN2 = 0;
  radii.forEach((r,i)=>{
    let n = i+1;
    let r2 = r*r;
    sumNr2 += n*r2;
    sumN2 += n*n;
    table.innerHTML += `<tr><td>${n}</td><td>${r.toFixed(1)}</td><td>${r2.toFixed(1)}</td></tr>`;
  });

  let lambda = sumNr2 / (R * sumN2);
  document.getElementById("result").innerText =
    `Calculated Wavelength λ ≈ ${lambda.toFixed(2)} (pixel²/mm)`;

  src.delete(); gray.delete(); circles.delete();
}
</script>

</body>
</html>
